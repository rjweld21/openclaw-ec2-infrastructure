name: Deploy OpenClaw nginx HTTPS Proxy

on:
  push:
    branches: [main, master]
    paths:
      - 'infrastructure/cdk/lib/openclaw-nginx-stack.ts'
      - '.github/workflows/deploy-openclaw-nginx.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - verify
          - rollback

env:
  AWS_REGION: us-east-1
  OPENCLAW_INSTANCE_ID: i-0f7b10ac4566c4ea4

jobs:
  deploy-nginx:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS credentials and target EC2
        run: |
          echo "=== Verifying AWS access and target EC2 ==="
          aws sts get-caller-identity
          
          echo "Checking target EC2 instance..."
          aws ec2 describe-instances \
            --instance-ids ${{ env.OPENCLAW_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].[InstanceId,State.Name,PublicIpAddress]' \
            --output table
          
          # Store public IP for later steps
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ env.OPENCLAW_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "Target EC2 Public IP: $PUBLIC_IP"
      
      - name: Set up Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: infrastructure/cdk/package.json
      
      - name: Install CDK dependencies
        working-directory: ./infrastructure/cdk
        run: npm install
      
      - name: Install CDK CLI
        run: npm install -g aws-cdk
      
      - name: CDK Bootstrap (if needed)
        working-directory: ./infrastructure/cdk
        run: |
          echo "Ensuring CDK bootstrap..."
          cdk bootstrap --app "npx ts-node bin/openclaw-ec2-infrastructure.ts" || true
      
      - name: CDK Deploy nginx Stack
        working-directory: ./infrastructure/cdk
        run: |
          echo "Deploying OpenClaw nginx HTTPS proxy stack..."
          cdk deploy OpenClawNginxProxyStack \
            --app "npx ts-node bin/openclaw-ec2-infrastructure.ts" \
            --require-approval never \
            --outputs-file nginx-outputs.json
          
          echo "CDK Outputs:"
          cat nginx-outputs.json
          
          # Extract SSM document name
          SSM_DOC_NAME=$(jq -r '.OpenClawNginxProxyStack.NginxSetupDocumentName' nginx-outputs.json)
          echo "SSM_DOC_NAME=$SSM_DOC_NAME" >> $GITHUB_ENV
      
      - name: Execute nginx Setup via SSM
        run: |
          echo "Executing nginx setup on EC2 instance via SSM..."
          
          COMMAND_ID=$(aws ssm send-command \
            --document-name "${{ env.SSM_DOC_NAME }}" \
            --instance-ids "${{ env.OPENCLAW_INSTANCE_ID }}" \
            --parameters "instanceId=${{ env.OPENCLAW_INSTANCE_ID }}" \
            --query 'Command.CommandId' \
            --output text)
          
          echo "SSM Command ID: $COMMAND_ID"
          
          # Wait for command completion
          echo "Waiting for SSM command to complete..."
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ env.OPENCLAW_INSTANCE_ID }}" \
              --query 'Status' \
              --output text)
            
            echo "Command status: $STATUS (attempt $i/30)"
            
            if [ "$STATUS" = "Success" ]; then
              echo "âœ… nginx setup completed successfully!"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "âŒ nginx setup failed!"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.OPENCLAW_INSTANCE_ID }}" \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            
            sleep 10
          done
          
          # Get command output
          echo "Command output:"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.OPENCLAW_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text
      
      - name: Update Security Group for HTTPS
        run: |
          echo "Updating security group to allow HTTPS traffic..."
          
          # Get security group ID
          SG_ID=$(aws ec2 describe-instances \
            --instance-ids "${{ env.OPENCLAW_INSTANCE_ID }}" \
            --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' \
            --output text)
          
          echo "Security Group: $SG_ID"
          
          # Add HTTPS rule (ignore if already exists)
          aws ec2 authorize-security-group-ingress \
            --group-id "$SG_ID" \
            --protocol tcp \
            --port 443 \
            --cidr 0.0.0.0/0 \
            --tag-specifications "ResourceType=security-group-rule,Tags=[{Key=Name,Value=HTTPS-OpenClaw}]" \
            2>/dev/null || echo "HTTPS rule already exists"
          
          echo "âœ… Security group updated for HTTPS access"
      
      - name: Verify nginx HTTPS Setup
        run: |
          echo "Verifying nginx HTTPS setup..."
          
          # Wait a bit for nginx to fully start
          sleep 30
          
          # Test HTTPS endpoint
          echo "Testing HTTPS endpoint: https://${{ env.PUBLIC_IP }}"
          
          # Basic connectivity test
          curl -k -s -o /dev/null -w "HTTPS Status: %{http_code}\\n" "https://${{ env.PUBLIC_IP }}" || echo "HTTPS test failed"
          
          # Test HTTP redirect
          curl -s -o /dev/null -w "HTTP->HTTPS Redirect: %{http_code}\\n" "http://${{ env.PUBLIC_IP }}" || echo "HTTP redirect test failed"
          
          echo "âœ… OpenClaw nginx HTTPS proxy deployment completed!"
      
      - name: Display Final Access Information
        run: |
          echo "ğŸ‰ OpenClaw nginx HTTPS Proxy Deployment Complete!"
          echo ""
          echo "ğŸ“‹ Access Information:"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ OpenClaw HTTPS URL: https://${{ env.PUBLIC_IP }}                      â”‚"
          echo "â”‚ OpenClaw HTTP URL:  http://${{ env.PUBLIC_IP }} (redirects to HTTPS) â”‚"
          echo "â”‚ SSH Command:        ssh -i ~/.ssh/openclaw-key-fixed.pem ec2-user@${{ env.PUBLIC_IP }} â”‚"
          echo "â”‚ Instance ID:        ${{ env.OPENCLAW_INSTANCE_ID }}                   â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "ğŸ”’ HTTPS Features Now Available:"
          echo "   âœ… Secure WebSocket connections"
          echo "   âœ… Real-time dashboard updates"
          echo "   âœ… Full OpenClaw functionality"
          echo "   âœ… Browser security compliance"
          echo ""
          echo "ğŸ’¡ Next Steps:"
          echo "   1. Open https://${{ env.PUBLIC_IP }} in your browser"
          echo "   2. Accept the self-signed certificate warning"
          echo "   3. Enjoy full OpenClaw functionality with HTTPS!"