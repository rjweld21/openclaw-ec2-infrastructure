AWSTemplateFormatVersion: '2010-09-09'
Description: 'OpenClaw Personal Edition - Cost-optimized deployment with your own Anthropic API key and automated start/stop scheduling'

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: 'EC2 Key Pair for emergency SSH access (SSM is primary access method)'
    
  AnthropicApiKey:
    Type: String
    Description: 'Your Anthropic API key (sk-ant-...)'
    NoEcho: true
    AllowedPattern: 'sk-ant-.*'
    ConstraintDescription: 'Must be a valid Anthropic API key starting with sk-ant-'
    
  InstanceType:
    Type: String
    Default: 't4g.medium'
    AllowedValues:
      - t4g.small
      - t4g.medium
      - t4g.large
      - t3.small
      - t3.medium
      - t3.large
    Description: 'EC2 instance type (t4g.medium recommended for balanced cost/performance)'
    
  StartSchedule:
    Type: String
    Default: 'cron(0 13 ? * MON-FRI *)'
    Description: 'When to start the instance (default: 8am EST weekdays, UTC: 1pm)'
    
  StopSchedule:
    Type: String
    Default: 'cron(0 1 ? * TUE-SAT *)'
    Description: 'When to stop the instance (default: 8pm EST weekdays, UTC: 1am next day)'
    
  TimeZone:
    Type: String
    Default: 'America/New_York'
    Description: 'Your timezone for OpenClaw'
    
  IdleShutdownMinutes:
    Type: Number
    Default: 30
    MinValue: 10
    MaxValue: 120
    Description: 'Minutes of idle time before auto-shutdown (default: 30)'

Resources:
  # VPC and Networking (minimal setup, no VPC endpoints)
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'
          
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'
          
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
      
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet'
          
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-rt'
          
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway
      
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Security Groups
  OpenClawSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'OpenClaw instance security group - SSM access only'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'HTTPS outbound for package downloads and API calls'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: '0.0.0.0/0'
          Description: 'All outbound traffic'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-sg'

  # IAM Roles and Policies
  OpenClawRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: OpenClawParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/*'

  OpenClawInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref OpenClawRole

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: EC2Control
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                Resource: '*'
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                  - cloudwatch:GetMetricStatistics
                Resource: '*'

  # Parameter Store for API Key
  AnthropicApiKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${AWS::StackName}/anthropic-api-key'
      Type: SecureString
      Value: !Ref AnthropicApiKey
      Description: 'Anthropic API key for OpenClaw'

  # S3 Bucket for Start/Stop Web Page
  StartStopWebBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-startstop-${AWS::AccountId}'
      PublicReadWritePolicy: 
        Version: '2012-10-17'
        Statement:
          - Sid: PublicRead
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${AWS::S3::Bucket}/*'
      WebsiteConfiguration:
        IndexDocument: 'index.html'
        ErrorDocument: 'error.html'

  # Lambda Functions
  StartInstanceFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-start-instance'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Environment:
        Variables:
          INSTANCE_ID: !Ref OpenClawInstance
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          
          ec2 = boto3.client('ec2')
          
          def lambda_handler(event, context):
              instance_id = os.environ['INSTANCE_ID']
              
              try:
                  # Check current state
                  response = ec2.describe_instances(InstanceIds=[instance_id])
                  state = response['Reservations'][0]['Instances'][0]['State']['Name']
                  
                  if state in ['stopped', 'stopping']:
                      # Start the instance
                      ec2.start_instances(InstanceIds=[instance_id])
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Content-Type': 'application/json',
                              'Access-Control-Allow-Origin': '*'
                          },
                          'body': json.dumps({
                              'message': f'Starting instance {instance_id}',
                              'previousState': state,
                              'action': 'start'
                          })
                      }
                  else:
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Content-Type': 'application/json',
                              'Access-Control-Allow-Origin': '*'
                          },
                          'body': json.dumps({
                              'message': f'Instance {instance_id} is already {state}',
                              'currentState': state,
                              'action': 'none'
                          })
                      }
                      
              except Exception as e:
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }

  StopInstanceFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-stop-instance'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Environment:
        Variables:
          INSTANCE_ID: !Ref OpenClawInstance
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          
          ec2 = boto3.client('ec2')
          
          def lambda_handler(event, context):
              instance_id = os.environ['INSTANCE_ID']
              
              try:
                  # Check current state
                  response = ec2.describe_instances(InstanceIds=[instance_id])
                  state = response['Reservations'][0]['Instances'][0]['State']['Name']
                  
                  if state in ['running', 'pending']:
                      # Stop the instance
                      ec2.stop_instances(InstanceIds=[instance_id])
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Content-Type': 'application/json',
                              'Access-Control-Allow-Origin': '*'
                          },
                          'body': json.dumps({
                              'message': f'Stopping instance {instance_id}',
                              'previousState': state,
                              'action': 'stop'
                          })
                      }
                  else:
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Content-Type': 'application/json',
                              'Access-Control-Allow-Origin': '*'
                          },
                          'body': json.dumps({
                              'message': f'Instance {instance_id} is already {state}',
                              'currentState': state,
                              'action': 'none'
                          })
                      }
                      
              except Exception as e:
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }

  CheckStatusFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-check-status'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Environment:
        Variables:
          INSTANCE_ID: !Ref OpenClawInstance
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from datetime import datetime
          
          ec2 = boto3.client('ec2')
          cloudwatch = boto3.client('cloudwatch')
          
          def lambda_handler(event, context):
              instance_id = os.environ['INSTANCE_ID']
              
              try:
                  # Get instance state
                  response = ec2.describe_instances(InstanceIds=[instance_id])
                  instance = response['Reservations'][0]['Instances'][0]
                  state = instance['State']['Name']
                  
                  result = {
                      'instanceId': instance_id,
                      'state': state,
                      'stateTransitionReason': instance.get('StateTransitionReason', ''),
                      'timestamp': datetime.now().isoformat()
                  }
                  
                  # If running, get additional info
                  if state == 'running':
                      result['publicDnsName'] = instance.get('PublicDnsName', '')
                      result['publicIpAddress'] = instance.get('PublicIpAddress', '')
                      
                      # Get recent CPU usage for idle detection
                      try:
                          cpu_response = cloudwatch.get_metric_statistics(
                              Namespace='AWS/EC2',
                              MetricName='CPUUtilization',
                              Dimensions=[{
                                  'Name': 'InstanceId',
                                  'Value': instance_id
                              }],
                              StartTime=datetime.utcnow().replace(microsecond=0) - timedelta(minutes=30),
                              EndTime=datetime.utcnow().replace(microsecond=0),
                              Period=300,
                              Statistics=['Average']
                          )
                          
                          if cpu_response['Datapoints']:
                              avg_cpu = sum(dp['Average'] for dp in cpu_response['Datapoints']) / len(cpu_response['Datapoints'])
                              result['avgCpuLast30Min'] = round(avg_cpu, 2)
                          
                      except Exception as cpu_error:
                          result['cpuError'] = str(cpu_error)
                  
                  return {
                      'statusCode': 200,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps(result)
                  }
                  
              except Exception as e:
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }

  # Lambda Function URLs (free alternative to API Gateway)
  StartInstanceFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      TargetFunctionArn: !GetAtt StartInstanceFunction.Arn
      AuthType: NONE
      Cors:
        AllowCredentials: false
        AllowMethods: ['GET', 'POST']
        AllowOrigins: ['*']

  StopInstanceFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      TargetFunctionArn: !GetAtt StopInstanceFunction.Arn
      AuthType: NONE
      Cors:
        AllowCredentials: false
        AllowMethods: ['GET', 'POST']
        AllowOrigins: ['*']

  CheckStatusFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      TargetFunctionArn: !GetAtt CheckStatusFunction.Arn
      AuthType: NONE
      Cors:
        AllowCredentials: false
        AllowMethods: ['GET']
        AllowOrigins: ['*']

  # Lambda Permissions for Function URLs
  StartInstanceFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StartInstanceFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  StopInstanceFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StopInstanceFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  CheckStatusFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CheckStatusFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  # EventBridge Rules for Scheduling
  StartInstanceRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${AWS::StackName}-start-schedule'
      Description: 'Start OpenClaw instance on schedule'
      ScheduleExpression: !Ref StartSchedule
      State: ENABLED
      Targets:
        - Arn: !GetAtt StartInstanceFunction.Arn
          Id: StartInstanceTarget

  StopInstanceRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${AWS::StackName}-stop-schedule'
      Description: 'Stop OpenClaw instance on schedule'
      ScheduleExpression: !Ref StopSchedule
      State: ENABLED
      Targets:
        - Arn: !GetAtt StopInstanceFunction.Arn
          Id: StopInstanceTarget

  # EventBridge Permissions
  StartInstanceRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StartInstanceFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt StartInstanceRule.Arn

  StopInstanceRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StopInstanceFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt StopInstanceRule.Arn

  # CloudWatch Alarm for Auto-Idle Shutdown
  IdleShutdownAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-idle-shutdown'
      AlarmDescription: 'Auto-stop instance when idle'
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: !Ref IdleShutdownMinutes
      Threshold: 5
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref OpenClawInstance
      AlarmActions:
        - !GetAtt StopInstanceFunction.Arn
      TreatMissingData: notBreaching

  # CloudWatch Alarm Permission
  IdleShutdownAlarmPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StopInstanceFunction
      Action: lambda:InvokeFunction
      Principal: lambda.alarms.cloudwatch.amazonaws.com
      SourceArn: !GetAtt IdleShutdownAlarm.Arn

  # EC2 Instance
  OpenClawInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-${AWS::Partition}-gp2}}'
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref OpenClawSecurityGroup
      SubnetId: !Ref PublicSubnet
      IamInstanceProfile: !Ref OpenClawInstanceProfile
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
            DeleteOnTermination: false
            Encrypted: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          
          # Install SSM agent (should be pre-installed on Amazon Linux 2)
          yum install -y amazon-ssm-agent
          systemctl enable amazon-ssm-agent
          systemctl start amazon-ssm-agent
          
          # Install CloudWatch agent
          yum install -y amazon-cloudwatch-agent
          
          # Create user for OpenClaw
          useradd -m -s /bin/bash openclaw
          usermod -aG wheel openclaw
          
          # Install Node.js 22 via NVM as openclaw user
          sudo -u openclaw bash -c "
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
          source ~/.bashrc
          nvm install 22
          nvm use 22
          nvm alias default 22
          "
          
          # Install Docker
          yum install -y docker
          systemctl enable docker
          systemctl start docker
          usermod -aG docker openclaw
          
          # Install OpenClaw
          sudo -u openclaw bash -c "
          source ~/.bashrc
          npm install -g openclaw@latest
          "
          
          # Get Anthropic API key from Parameter Store
          API_KEY=$(aws ssm get-parameter --name '/${AWS::StackName}/anthropic-api-key' --with-decryption --region ${AWS::Region} --output text --query 'Parameter.Value')
          
          # Configure OpenClaw
          sudo -u openclaw bash -c "
          mkdir -p ~/.openclaw
          cat > ~/.openclaw/openclaw.json << EOF
          {
            \"gateway\": {
              \"port\": 18789,
              \"bind\": \"0.0.0.0\",
              \"auth\": {
                \"token\": \"$(openssl rand -hex 32)\"
              }
            },
            \"models\": {
              \"default\": \"anthropic/claude-sonnet-4-20250514\",
              \"providers\": {
                \"anthropic\": {
                  \"apiKey\": \"$API_KEY\"
                }
              }
            },
            \"agent\": {
              \"timezone\": \"${TimeZone}\"
            },
            \"session\": {
              \"pruning\": {
                \"enabled\": true,
                \"maxMessages\": 1000
              }
            }
          }
          EOF
          
          # Set up systemd service
          sudo tee /etc/systemd/system/openclaw.service > /dev/null << EOF
          [Unit]
          Description=OpenClaw Gateway
          After=network.target
          
          [Service]
          Type=simple
          User=openclaw
          WorkingDirectory=/home/openclaw
          Environment=PATH=/home/openclaw/.nvm/versions/node/v22.12.0/bin:/usr/local/bin:/usr/bin:/bin
          Environment=NODE_ENV=production
          ExecStart=/home/openclaw/.nvm/versions/node/v22.12.0/bin/openclaw gateway --config /home/openclaw/.openclaw/openclaw.json
          Restart=always
          RestartSec=10
          StandardOutput=syslog
          StandardError=syslog
          SyslogIdentifier=openclaw
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          systemctl daemon-reload
          systemctl enable openclaw
          systemctl start openclaw
          "
          
          # Configure CloudWatch monitoring
          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << EOF
          {
            \"metrics\": {
              \"namespace\": \"OpenClaw/Personal\",
              \"metrics_collected\": {
                \"cpu\": {
                  \"measurement\": [\"cpu_usage_idle\", \"cpu_usage_iowait\"],
                  \"metrics_collection_interval\": 300
                },
                \"mem\": {
                  \"measurement\": [\"mem_used_percent\"],
                  \"metrics_collection_interval\": 300
                }
              }
            },
            \"logs\": {
              \"logs_collected\": {
                \"files\": {
                  \"collect_list\": [
                    {
                      \"file_path\": \"/var/log/messages\",
                      \"log_group_name\": \"/aws/ec2/openclaw/${AWS::StackName}\",
                      \"log_stream_name\": \"system\",
                      \"timezone\": \"UTC\"
                    }
                  ]
                }
              }
            }
          }
          EOF
          
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
            -a fetch-config -m ec2 -s \
            -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
          
          # Signal CloudFormation that setup is complete
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource OpenClawInstance --region ${AWS::Region}
          
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-instance'
        - Key: Project
          Value: 'OpenClaw-Personal'
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT15M

  # CloudWatch Log Group
  OpenClawLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/ec2/openclaw/${AWS::StackName}'
      RetentionInDays: 7

Outputs:
  InstanceId:
    Description: 'EC2 Instance ID'
    Value: !Ref OpenClawInstance
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'
  
  InstanceDNS:
    Description: 'Public DNS of the instance (when running)'
    Value: !GetAtt OpenClawInstance.PublicDnsName
    Export:
      Name: !Sub '${AWS::StackName}-InstanceDNS'
      
  StartStopPageURL:
    Description: 'URL for the Start/Stop control page'
    Value: !Sub 'https://${StartStopWebBucket}.s3.amazonaws.com/index.html'
    Export:
      Name: !Sub '${AWS::StackName}-StartStopURL'
      
  SSMPortForwardCommand:
    Description: 'Command to start port forwarding via SSM'
    Value: !Sub |
      aws ssm start-session --target ${OpenClawInstance} --document-name AWS-StartPortForwardingSession --parameters '{"portNumber":["18789"],"localPortNumber":["18789"]}'
    Export:
      Name: !Sub '${AWS::StackName}-SSMCommand'
      
  OpenClawURL:
    Description: 'OpenClaw Web UI URL (after port forwarding)'
    Value: 'http://localhost:18789'
    Export:
      Name: !Sub '${AWS::StackName}-OpenClawURL'
      
  StartFunctionURL:
    Description: 'Lambda Function URL to start instance'
    Value: !GetAtt StartInstanceFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-StartFunctionURL'
      
  StopFunctionURL:
    Description: 'Lambda Function URL to stop instance'
    Value: !GetAtt StopInstanceFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-StopFunctionURL'
      
  StatusFunctionURL:
    Description: 'Lambda Function URL to check status'
    Value: !GetAtt CheckStatusFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-StatusFunctionURL'
      
  EstimatedMonthlyCost:
    Description: 'Estimated monthly AWS cost (12 hrs/day usage)'
    Value: '$15.50 (EC2: $12.10, EBS: $2.40, Other: $1.00)'
    Export:
      Name: !Sub '${AWS::StackName}-MonthlyCost'